{
  "info": {
    "name": "Anubis eDoc API",
    "_postman_id": "4f74d5f6-7af7-4a94-b1ce-e0c218a6af01",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "description": "Полная коллекция для проверки REST-обёртки eDocument Export Service. Содержит сценарии получения документов, детальной проверки данных и подтверждения экспорта, а также поиск всех типов контактов."
  },
  "item": [
    {
      "name": "Session",
      "item": [
        {
          "name": "LogOn (get sessionId)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"clientAuthenticationToken\": \"{{clientAuthToken}}\",\n  \"serviceVersion\": \"{{serviceVersion}}\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/edoc/session/logon",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "edoc",
                "session",
                "logon"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Статус 200', () => pm.response.to.have.status(200));",
                  "const body = pm.response.json();",
                  "pm.expect(body).to.have.property('sessionId');",
                  "pm.expect(body.sessionId).to.be.a('string').and.not.be.empty;",
                  "pm.collectionVariables.set('sessionId', body.sessionId);"
                ]
              }
            }
          ]
        },
        {
          "name": "LogOut (close session)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"sessionId\": \"{{sessionId}}\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/edoc/session/logout",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "edoc",
                "session",
                "logout"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Статус 204', () => pm.response.to.have.status(204));",
                  "pm.collectionVariables.unset('sessionId');"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Documents",
      "item": [
        {
          "name": "List documents by type and period",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/edoc/documents?sessionId={{sessionId}}&type={{documentType}}&from={{periodFrom}}&to={{periodTo}}&contactType={{contactType}}&contactId={{contactId}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "edoc",
                "documents"
              ],
              "query": [
                {
                  "key": "sessionId",
                  "value": "{{sessionId}}"
                },
                {
                  "key": "type",
                  "value": "{{documentType}}"
                },
                {
                  "key": "from",
                  "value": "{{periodFrom}}",
                  "disabled": false
                },
                {
                  "key": "to",
                  "value": "{{periodTo}}",
                  "disabled": false
                },
                {
                  "key": "contactType",
                  "value": "{{contactType}}",
                  "disabled": true
                },
                {
                  "key": "contactId",
                  "value": "{{contactId}}",
                  "disabled": true
                }
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const ensure = (key, valueFactory) => {",
                  "  if (!pm.collectionVariables.get(key)) {",
                  "    pm.collectionVariables.set(key, valueFactory());",
                  "  }",
                  "};",
                  "ensure('periodFrom', () => moment().subtract(30, 'days').format('YYYY-MM-DD'));",
                  "ensure('periodTo', () => moment().format('YYYY-MM-DD'));",
                  "if (!pm.collectionVariables.get('baseUrl')) {",
                  "  pm.collectionVariables.set('baseUrl', pm.variables.get('baseUrl') || 'http://localhost:4102');",
                  "}",
                  "if (!/^https?:\\/\\//.test(pm.collectionVariables.get('baseUrl'))) {",
                  "  throw new Error('baseUrl должен содержать http или https, чтобы избежать ошибок CORS/Fetch');",
                  "}",
                  "if (!pm.collectionVariables.get('sessionId')) {",
                  "  throw new Error('sessionId обязателен. Сначала выполните LogOn (получить sessionId)');",
                  "}",
                  "const hasContactType = !!pm.collectionVariables.get('contactType');",
                  "const hasContactId = !!pm.collectionVariables.get('contactId');",
                  "const contactTypeParam = pm.request.url.query.find(q => q.key === 'contactType');",
                  "const contactIdParam = pm.request.url.query.find(q => q.key === 'contactId');",
                  "if (hasContactType && hasContactId) {",
                  "  contactTypeParam.disabled = false;",
                  "  contactIdParam.disabled = false;",
                  "} else {",
                  "  contactTypeParam.disabled = true;",
                  "  contactIdParam.disabled = true;",
                  "}"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Статус 200', () => pm.response.to.have.status(200));",
                  "const body = pm.response.json();",
                  "pm.expect(body).to.be.an('array', 'Ответ должен быть массивом');",
                  "if (body.length > 0) {",
                  "  const doc = body[0];",
                  "  ['id','number','documentType','documentStatus','exportStatus','registrationDate'].forEach(key => pm.expect(doc).to.have.property(key));",
                  "  pm.collectionVariables.set('documentId', doc.id);",
                  "  pm.collectionVariables.set('documentNumber', doc.number);",
                  "}",
                  "pm.collectionVariables.set('documentsFound', body.length);"
                ]
              }
            }
          ]
        },
        {
          "name": "Get document by ID (full details)",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/edoc/documents/{{documentId}}?full={{fullDetails}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "edoc",
                "documents",
                "{{documentId}}"
              ],
              "query": [
                {
                  "key": "full",
                  "value": "{{fullDetails}}"
                }
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "if (!pm.collectionVariables.get('documentId') && pm.variables.get('documentId') === '00000000-0000-0000-0000-000000000000') {",
                  "  throw new Error('Не задан documentId. Сначала выполните запрос получения списка документов или установите значение переменной.');",
                  "}"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Статус 200', () => pm.response.to.have.status(200));",
                  "const doc = pm.response.json();",
                  "['id','number','documentType','documentStatus','exportStatus','registrationDate','category'].forEach(key => pm.expect(doc).to.have.property(key));",
                  "pm.collectionVariables.set('documentId', doc.id);",
                  "const fullFlag = pm.request.url.query.find(q => q.key === 'full')?.value === 'true';",
                  "if (fullFlag) {",
                  "  pm.test('Файлы присутствуют при full=true', () => pm.expect(doc).to.have.property('files'));",
                  "  pm.test('Связанные документы присутствуют при full=true', () => pm.expect(doc).to.have.property('relatedDocuments'));",
                  "  if (doc.files && doc.files.length > 0) {",
                  "    pm.collectionVariables.set('documentFileName', doc.files[0].name);",
                  "  }",
                  "}",
                  "pm.test('Даты приведены к ISO', () => pm.expect(doc.registrationDate).to.match(/T/));"
                ]
              }
            }
          ]
        },
        {
          "name": "Mark document exported",
          "request": {
            "method": "POST",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/edoc/documents/{{documentId}}/exported",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "edoc",
                "documents",
                "{{documentId}}",
                "exported"
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "if (!pm.collectionVariables.get('documentId') && pm.variables.get('documentId') === '00000000-0000-0000-0000-000000000000') {",
                  "  throw new Error('Не задан documentId. Используйте запрос списка или детальный запрос перед пометкой экспорта.');",
                  "}"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Статус 204', () => pm.response.to.have.status(204));",
                  "pm.test('Тело ответа пустое', () => pm.expect(pm.response.text()).to.be.empty);"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Contacts",
      "item": [
        {
          "name": "Physical persons by personal number",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/edoc/contacts/physical/by-personalNumber?personalNumber={{personalNumber}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "edoc",
                "contacts",
                "physical",
                "by-personalNumber"
              ],
              "query": [
                {
                  "key": "personalNumber",
                  "value": "{{personalNumber}}"
                }
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Статус 200', () => pm.response.to.have.status(200));",
                  "const data = pm.response.json();",
                  "pm.expect(data).to.be.an('array');",
                  "if (data.length > 0) {",
                  "  const person = data[0];",
                  "  ['firstName','lastName','personalNumber'].forEach(key => pm.expect(person).to.have.property(key));",
                  "}",
                  "pm.collectionVariables.set('foundPhysicalCount', data.length);"
                ]
              }
            }
          ]
        },
        {
          "name": "Physical persons by name",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/edoc/contacts/physical/by-name?lastName={{lastName}}&firstName={{firstName}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "edoc",
                "contacts",
                "physical",
                "by-name"
              ],
              "query": [
                {
                  "key": "lastName",
                  "value": "{{lastName}}"
                },
                {
                  "key": "firstName",
                  "value": "{{firstName}}",
                  "disabled": false
                }
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Статус 200', () => pm.response.to.have.status(200));",
                  "const data = pm.response.json();",
                  "pm.expect(data).to.be.an('array');",
                  "if (data.length > 0) {",
                  "  const person = data[0];",
                  "  ['firstName','lastName','personalNumber'].forEach(key => pm.expect(person).to.have.property(key));",
                  "}",
                  "pm.collectionVariables.set('foundPhysicalByName', data.length);"
                ]
              }
            }
          ]
        },
        {
          "name": "Organizations by identification number",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/edoc/contacts/organizations/by-identificationNumber?identificationNumber={{identificationNumber}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "edoc",
                "contacts",
                "organizations",
                "by-identificationNumber"
              ],
              "query": [
                {
                  "key": "identificationNumber",
                  "value": "{{identificationNumber}}"
                }
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Статус 200', () => pm.response.to.have.status(200));",
                  "const data = pm.response.json();",
                  "pm.expect(data).to.be.an('array');",
                  "if (data.length > 0) {",
                  "  const org = data[0];",
                  "  ['name','identificationNumber'].forEach(key => pm.expect(org).to.have.property(key));",
                  "}",
                  "pm.collectionVariables.set('foundOrganizationsByCode', data.length);"
                ]
              }
            }
          ]
        },
        {
          "name": "Organizations by name",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/edoc/contacts/organizations/by-name?name={{organizationName}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "edoc",
                "contacts",
                "organizations",
                "by-name"
              ],
              "query": [
                {
                  "key": "name",
                  "value": "{{organizationName}}"
                }
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Статус 200', () => pm.response.to.have.status(200));",
                  "const data = pm.response.json();",
                  "pm.expect(data).to.be.an('array');",
                  "if (data.length > 0) {",
                  "  const org = data[0];",
                  "  ['name','identificationNumber'].forEach(key => pm.expect(org).to.have.property(key));",
                  "}",
                  "pm.collectionVariables.set('foundOrganizationsByName', data.length);"
                ]
              }
            }
          ]
        },
        {
          "name": "State structures",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/edoc/contacts/stateStructures?name={{structureName}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "edoc",
                "contacts",
                "stateStructures"
              ],
              "query": [
                {
                  "key": "name",
                  "value": "{{structureName}}",
                  "disabled": false
                }
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Статус 200', () => pm.response.to.have.status(200));",
                  "const data = pm.response.json();",
                  "pm.expect(data).to.be.an('array');",
                  "if (data.length > 0) {",
                  "  const struct = data[0];",
                  "  ['name','identificationCode'].forEach(key => pm.expect(struct).to.have.property(key));",
                  "}",
                  "pm.collectionVariables.set('foundStructures', data.length);"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Workflows",
      "item": [
        {
          "name": "Workflow: export first document from list",
          "request": {
            "method": "POST",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/edoc/documents/{{documentId}}/exported",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "edoc",
                "documents",
                "{{documentId}}",
                "exported"
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "if (!pm.collectionVariables.get('documentId')) {",
                  "  throw new Error('Для сценария экспорта сначала выполните \\\"List documents by type and period\\\" или задайте переменную documentId.');",
                  "}"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Статус 204', () => pm.response.to.have.status(204));",
                  "pm.test('Тело ответа пустое', () => pm.expect(pm.response.text()).to.be.empty);",
                  "pm.collectionVariables.set('workflowExportedDocumentId', pm.collectionVariables.get('documentId'));"
                ]
              }
            }
          ],
          "protocolProfileBehavior": {
            "disableBodyPruning": true
          }
        }
      ]
    }
  ],
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://localhost:4102"
    },
    {
      "key": "documentType",
      "value": "Incoming"
    },
    {
      "key": "periodFrom",
      "value": ""
    },
    {
      "key": "periodTo",
      "value": ""
    },
    {
      "key": "documentId",
      "value": "00000000-0000-0000-0000-000000000000"
    },
    {
      "key": "documentNumber",
      "value": ""
    },
    {
      "key": "fullDetails",
      "value": "true"
    },
    {
      "key": "personalNumber",
      "value": "12345678901"
    },
    {
      "key": "lastName",
      "value": "Doe"
    },
    {
      "key": "firstName",
      "value": "John"
    },
    {
      "key": "identificationNumber",
      "value": "123456789"
    },
    {
      "key": "organizationName",
      "value": "Contoso"
    },
    {
      "key": "structureName",
      "value": ""
    },
    {
      "key": "clientAuthToken",
      "value": "{BD081743-C0C4-43B6-A0C3-30914FC9888F}"
    },
    {
      "key": "serviceVersion",
      "value": "1.0.0.0"
    },
    {
      "key": "sessionId",
      "value": ""
    },
    {
      "key": "contactType",
      "value": "",
      "type": "string"
    },
    {
      "key": "contactId",
      "value": "",
      "type": "string"
    }
  ]
}